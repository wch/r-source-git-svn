name: Fetch from SVN and push to git

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Once an hour, at 48 minutes past the hour.
    - cron: "48 * * * *"


jobs:
  R-source-svn-update:
    runs-on: ubuntu-20.04
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Install git-svn
        # The PPA seems to be necessary; otherwise installing git-svn doesn't
        # work due to a version conflict with git.
        run: |
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get -y install git-svn

      - name: Checkout r-source-git-svn
        uses: actions/checkout@v2

      # Set git config, needed for making commits later.
      - name: Git Config
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Checkout r-source
        uses: actions/checkout@v2
        with:
          # Temporarily use wch/rs instead of wch/r-source, until we're
          # confident this will work reliably.
          repository: wch/rs
          path: r-source
          ref: trunk
          # This fetches all commits in the repo. Seems to be necessary for
          # git-svn to be happy; otherwise it says "error: invalid object" for
          # some files.
          fetch-depth: 0

      - name: Symlink git-svn metadata to r-source/.git/svn
        run: |
          cd r-source/.git
          ln -s ../../svn svn

      - name: Add svn-remote to .git/config
        run: |-
          cat <<EOF >> r-source/.git/config
          [svn-remote "svn"]
              url = https://svn.r-project.org/R
              fetch = trunk:refs/remotes/Rsvn/trunk
              branches = branches/*:refs/remotes/Rsvn/*
              tags = tags/*:refs/remotes/Rsvn/tags/*
          EOF

      - name: Fetch from SVN
        # The `git gc` seems to fix "error: invalid object", when used along
        # with the `fetch-depth: 0` above.
        run: |
          cd r-source
          git checkout trunk
          git gc
          git svn fetch
          git svn rebase

      - name: Commit to local r-source-git-svn
        run: |
          git add svn
          git status
          git commit -m"Update git-svn metadata"

      # - name: Push to remote r-source
      # This pushes all branches from Rsvn to origin
      #   run: |
      #     cd r-source
      #     git push origin refs/remotes/Rsvn/*:refs/heads/*

      # - name: Push to remote r-source-git-svn
      #   run:
      #     git push
