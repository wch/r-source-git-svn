name: Fetch from SVN and push to git

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run once an hour.
    - cron: "26 * * * *"


jobs:
  R-source-svn-update:
    runs-on: ubuntu-20.04
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Install git-svn
        # The PPA seems to be necessary; otherwise installing git-svn doesn't
        # work due to a version conflict with git.
        run: |
          sudo add-apt-repository ppa:git-core/ppa -y
          sudo apt-get update
          sudo apt-get -y install git-svn

      - name: Checkout r-source-git-svn
        uses: actions/checkout@v2
        with:
          # Get HEAD commit instead of merge commit, so that we can commit back
          # into this branch.
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Checkout r-source
        # Temporarily use wch/rs instead of wch/r-source, until we're
        # confident this will work reliably.
        # This fetches all commits in the repo. Seems to be necessary for
        # git-svn to be happy; otherwise it says "error: invalid object" for
        # some files.
        run: |
          git clone https://github.com/wch/rs.git r-source
          cd r-source
          git checkout trunk

      - name: Symlink git-svn metadata to r-source/.git/svn
        run: |
          cd r-source/.git
          ln -s ../../svn svn

      - name: Symlink refs/remotes/Rsvn metadata to r-source/refs/remotes/Rsvn
        run: |
          cd r-source/.git/refs/remotes
          ln -s ../../../../refs/remotes/Rsvn

      - name: Add svn-remote to .git/config
        run: |-
          cat <<EOF >> r-source/.git/config
          [svn-remote "svn"]
              url = https://svn.r-project.org/R
              fetch = trunk:refs/remotes/Rsvn/trunk
              branches = branches/*:refs/remotes/Rsvn/*
              tags = tags/*:refs/remotes/Rsvn/tags/*
          EOF

      - name: Fetch from SVN
        # The `git gc` seems to fix "error: invalid object", when used along
        # with the `fetch-depth: 0` above.
        run: |
          cd r-source
          git checkout trunk
          git gc
          git svn fetch
          git svn rebase

      # Set git config, needed for making commit in next step.
      - name: Git Config
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Commit to local r-source-git-svn
        run: |
          git add svn
          git status
          git branch -a
          git commit -m"Update git-svn metadata" || echo "No git-svn metadata changes to commit"
          git log --graph --pretty=tformat:'%h%d %s (%cr) <%an>' --abbrev-commit --all --date=relative -40

      - name: Push to remote r-source
        run: |
          cd r-source
          git push https://wch:${{ secrets.PAT_FOR_GITHUB }}@github.com/wch/rs.git refs/remotes/Rsvn/*:refs/heads/*

      - name: Push to remote r-source-git-svn (for pull requests)
        uses: r-lib/actions/pr-push@master
        if: github.event_name == 'pull_request'
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}


      # The steps below are meant to run on the main branch, either with a
      # push or scheduled run.
      # Branch name from https://stackoverflow.com/a/60302058/412655
      - name: Find branch name for r-source-git-svn
        if: github.event_name == 'schedule' || github.event_name == 'push'
        id: vars
        run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

      - name: Check branch name
        if: github.event_name == 'schedule' || github.event_name == 'push'
        run: echo ${{ steps.vars.outputs.short_ref }}

      - name: Push to remote r-source-git-svn (for scheduled runs on main branch)
        if: github.event_name == 'schedule' || github.event_name == 'push'
        # Push to the branch that we're currently on. (Should be main)
        run: |
          git push origin HEAD:${{ steps.vars.outputs.short_ref }}
